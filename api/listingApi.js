import{BASE_URL,myFunction}from"./baseApi.js";const loader=document.getElementById("loader"),tabs=document.getElementById("myTabContent");export const getAllListings=async(e,t)=>{try{loader.style.display="block",tabs&&(tabs.style.display="none");const n=await fetch(`${BASE_URL}/listing?page=${e}&limit=${t}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);return loader.style.display="none",tabs&&(tabs.style.display="block"),await n.json()}catch(e){return console.error("Error fetching items:",e),null}};export const getListingById=async e=>{try{const t=await fetch(`${BASE_URL}/listing/${e}`,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.json()}catch(e){return console.error("Error fetching item:",e),null}};export const addListing=async e=>{try{loader.style.display="block",tabs&&(tabs.style.display="none");const t=await fetch(`${BASE_URL}/listing`,{method:"POST",body:e,credentials:"include"});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return loader.style.display="none",tabs&&(tabs.style.display="block"),await t.json()}catch(e){return console.error("Error adding item:",e),null}};export const updateListingById=async(e,t)=>{try{loader.style.display="block",tabs&&(tabs.style.display="none");const n=await fetch(`${BASE_URL}/listing/${e}`,{method:"PUT",body:t,credentials:"include"});if(!n.ok)throw new Error(`HTTP error! Status: ${n.status}`);return loader.style.display="none",tabs&&(tabs.style.display="block"),await n.json()}catch(e){return console.error("Error updating item:",e),null}};export const deleteListingById=async e=>{try{loader.style.display="block",tabs&&(tabs.style.display="none");const t=await fetch(`${BASE_URL}/listing/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"},credentials:"include"});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return loader.style.display="none",tabs&&(tabs.style.display="block"),await t.json()}catch(e){return console.error("Error deleting item:",e),null}};let editingListingId=null;const page=1,limit=8;let currentPage=1,totalPages=1,imagesToRemove=[],newImages=[];const fetchData=async(e,t,n=1)=>{const o=document.getElementById(t);o.innerHTML="";try{if("listing"===e){const e=await getAllListings(n,8);populateListingsTable(o,e),updatePaginationControls("listing-pagination-container",e.currentPage,e.totalPages)}}catch(t){console.error(`Error fetching ${e}:`,t)}},updatePaginationControls=(e,t,n)=>{const o=document.getElementById(e);if(o.innerHTML="",t>1){const e=document.createElement("button");e.textContent="<",e.classList.add("btn","btn-secondary","btn-sm","me-2"),e.addEventListener("click",(()=>{fetchData("listing","listings-container",t-1)})),o.appendChild(e)}const a=document.createElement("span");if(a.textContent=`Page ${t} of ${n}`,a.classList.add("pagination-info","ms-3"),o.appendChild(a),t<n){const e=document.createElement("button");e.textContent=">",e.classList.add("btn","btn-secondary","btn-sm","ms-2"),e.addEventListener("click",(()=>{fetchData("listing","listings-container",t+1)})),o.appendChild(e)}},renderMedia=e=>{const t=document.getElementById("mediaPreview");t.innerHTML="",e.forEach(((n,o)=>{const a=document.createElement("div");a.classList.add("media-item","me-3","mb-3"),a.innerHTML=`\n      <img src="${n}" alt="Media Preview" class="img-thumbnail" style="width: 100px; height: 100px; object-fit: cover;" />\n      <button type="button" class="btn btn-danger btn-sm mt-2 removeMedia" data-index="${o}">\n        Remove\n      </button>\n    `,t.appendChild(a),a.querySelector(".removeMedia").addEventListener("click",(()=>{imagesToRemove.push(n),e.splice(o,1),renderMedia(e)}))}))},editListing=e=>{console.log("Edit listing Functionality"),editingListingId=e,getListingById(e).then((e=>{populateEditListingForm(e)}))},deleteListing=e=>{console.log("delete Listing Functionality"),editingListingId=e,getListingById(e).then((async e=>{await deleteListingById(e._id),fetchData("listing","listings-container",currentPage);document.getElementById("mediaPreview").innerHTML="",newImages=[],imagesToRemove=[]}))};export const populateListingsTable=(e,t)=>{const{currentPage:n,totalPages:o}=t;console.log(n,o),currentPage=n,totalPages=o,updatePaginationControls("listing-pagination-container",n,o),t.data.forEach((t=>{const n=document.createElement("tr");n.innerHTML=`\n   <td>${t.title}</td>\n            <td>${t.price}</td>\n            <td>${t.bedrooms}</td>\n            <td>${t.bathrooms}</td>\n            <td>${t.area}</td>\n           <td>${t.location.city} ${t.location.locality} ${t.location.microMarket}? , ${t.location.microMarket}\n              : ""\n          } </td>\n            <td>${t.highlights?.description.slice(0,50)}${t.highlights?.description.length>50?"...":""}</td>\n\n              <td>\n        <button class="btn btn-warning btn-sm edit-btn" data-id="${t._id}">Edit</button>\n        <button class="btn btn-danger btn-sm delete-btn" data-id="${t._id}">Delete</button>\n      </td>\n    `,e.appendChild(n)}));e.querySelectorAll(".edit-btn").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.dataset.id;editListing(t)}))}));e.querySelectorAll(".delete-btn").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.dataset.id;deleteListing(t)}))}))};export const populateEditListingForm=e=>{document.getElementById("title").value=e.title,document.getElementById("price").value=e.price,document.getElementById("map").value=e.map||"",document.getElementById("bedrooms").value=e.bedrooms||"",document.getElementById("bathrooms").value=e.bathrooms||"",document.getElementById("additionalRooms").value=e.additionalRooms||"",document.getElementById("balcony").value=e.balcony||"",document.getElementById("facing").value=e.facing||"",document.getElementById("floorNumber").value=e.floorNumber||"",document.getElementById("flooring").value=e.flooring||"",document.getElementById("powerBackup").value=e.powerBackup||"",document.getElementById("totalFloors").value=e.totalFloors||"",document.getElementById("unitNumber").value=e.unitNumber||"",document.getElementById("view").value=e.view||"",document.getElementById("area").value=e.area||"",document.getElementById("highlightDescription").value=e.highlights.description||"",document.getElementById("furnishingStatus").value=e.furnishingStatus||"",document.getElementById("city").value=e.location?.city||"",document.getElementById("locality").value=e.location?.locality||"",document.getElementById("microMarket").value=e.location?.microMarket||"",document.getElementById("listingType").value=e.propertyDetails?.listingType||"",document.getElementById("buildingType").value=e.propertyDetails?.buildingType||"",document.getElementById("propertyType").value=e.propertyDetails?.propertyType||"",document.getElementById("whatsapp").value=e.contactOptions?.whatsapp||"",document.getElementById("phone").value=e.contactOptions?.phone||"";const t=document.getElementById("highlightPointsContainer"),n=document.getElementById("highlightTagsContainer");n.innerHTML="",e.highlights?.tags?.forEach(((t,o)=>{const a=document.createElement("div");a.classList.add("highlight-tag-item","mb-2"),a.innerHTML=`\n    <input\n      type="text"\n      class="form-control highlightTag"\n      value="${t}"\n      placeholder="Edit tag ${o+1}"\n    />\n    <button\n      type="button"\n      class="btn btn-danger removeTag mt-2"\n    >\n      - Remove\n    </button>\n  `,n.appendChild(a);a.querySelector(".removeTag").addEventListener("click",(()=>{n.removeChild(a)}));const i=document.getElementById("mediaPreview");i.innerHTML="";[...e.media||[]].forEach(((e,t)=>{const n=document.createElement("div");n.classList.add("media-item","me-3","mb-3"),n.innerHTML=`\n      <img\n        src="${e}"\n        alt="Media Preview"\n        class="img-thumbnail"\n        style="width: 100px; height: 100px; object-fit: cover;"\n      />\n      <button\n        type="button"\n        class="btn btn-danger btn-sm mt-2 removeExistingMedia"\n        data-url="${e}"\n      >\n        - Remove\n      </button>\n    `,i.appendChild(n);n.querySelector(".removeExistingMedia").addEventListener("click",(()=>{imagesToRemove.push(e),n.remove()}))})),document.getElementById("media").value=""})),t.innerHTML="",e.highlights?.points?.forEach(((e,n)=>{const o=document.createElement("div");o.classList.add("highlight-point-item","mb-2"),o.innerHTML=`\n    <input\n      type="text"\n      class="form-control highlightPoint"\n      value="${e}"\n      placeholder="Edit point ${n+1}"\n    />\n    <button\n      type="button"\n      class="btn btn-danger removePoint mt-2"\n    >\n      - Remove\n    </button>\n  `,t.appendChild(o);o.querySelector(".removePoint").addEventListener("click",(()=>{t.removeChild(o)}))})),document.getElementById("media").value=""};export const handleListingFormSubmission=async(e,t)=>{e.preventDefault();const n=document.getElementById("title").value,o=document.getElementById("price").value,a=document.getElementById("map").value,i=document.getElementById("bedrooms").value,l=document.getElementById("bathrooms").value,d=document.getElementById("area").value,s=document.getElementById("furnishingStatus").value,r=document.getElementById("city").value,c=document.getElementById("locality").value,m=document.getElementById("microMarket").value,g=document.getElementById("listingType").value,u=document.getElementById("buildingType").value,p=document.getElementById("propertyType").value,y=document.getElementById("whatsapp").value,h=document.getElementById("phone").value,E=document.getElementById("highlightDescription").value,b=document.getElementById("additionalRooms").value,v=document.getElementById("balcony").value,I=document.getElementById("facing").value,B=document.getElementById("floorNumber").value,L=document.getElementById("flooring").value,f=document.getElementById("powerBackup").value,T=document.getElementById("totalFloors").value,w=document.getElementById("unitNumber").value,$=document.getElementById("view").value,P=(document.getElementById("media").files[0],[]),k=[];document.querySelectorAll("#highlightPointsContainer input").forEach((e=>{e.value.trim()&&P.push(e.value.trim())})),document.querySelectorAll("#highlightTagsContainer input").forEach((e=>{e.value.trim()&&k.push(e.value.trim())}));const M=new FormData;M.append("title",n),M.append("price",o),M.append("map",a),M.append("bedrooms",i),M.append("bathrooms",l),M.append("area",d),M.append("additionalRooms",b),M.append("balcony",v),M.append("facing",I),M.append("floorNumber",B),M.append("flooring",L),M.append("powerBackup",f),M.append("totalFloors",T),M.append("unitNumber",w),M.append("view",$),M.append("furnishingStatus",s),M.append("location[city]",r),M.append("location[locality]",c),M.append("location[microMarket]",m),M.append("propertyDetails[listingType]",g),M.append("propertyDetails[buildingType]",u),M.append("propertyDetails[propertyType]",p),M.append("contactOptions[whatsapp]",y),M.append("contactOptions[phone]",h),M.append("highlights[description]",E),newImages&&newImages.length>0&&newImages.forEach((e=>{M.append("photos",e)})),imagesToRemove.length>0&&(console.log(imagesToRemove),M.append("imagesToRemove",JSON.stringify(imagesToRemove))),P.forEach(((e,t)=>{M.append(`highlights[points][${t}]`,e)})),k.forEach(((e,t)=>{M.append(`highlights[tags][${t}]`,e)}));try{t?await updateListingById(t,M):await addListing(M),document.getElementById("listingForm").reset(),myFunction("Listing Submitted Successfully"),fetchData("listing","listings-container",currentPage);document.getElementById("mediaPreview").innerHTML="",newImages=[],imagesToRemove=[]}catch(e){console.error("Error handling form submission:",e)}};document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("media"),t=document.getElementById("mediaPreview");e.addEventListener("change",(e=>{Array.from(e.target.files).forEach((e=>{const n=new FileReader;n.onload=n=>{const o=document.createElement("div");o.classList.add("media-item","me-3","mb-3"),o.innerHTML=`\n          <img\n            src="${n.target.result}"\n            alt="New Media Preview"\n            class="img-thumbnail"\n            style="width: 100px; height: 100px; object-fit: cover;"\n          />\n          <button\n            type="button"\n            class="btn btn-danger btn-sm mt-2 removeNewMedia"\n          >\n            - Remove\n          </button>\n        `,t.appendChild(o),newImages.push(e),console.log(newImages);o.querySelector(".removeNewMedia").addEventListener("click",(()=>{newImages=newImages.filter((t=>t!==e)),o.remove()}))},n.readAsDataURL(e)}))})),document.getElementById("listingForm").addEventListener("submit",(e=>{handleListingFormSubmission(e,editingListingId)}));const n=document.getElementById("highlightTagsContainer"),o=document.getElementById("highlightPointsContainer");document.getElementById("addHighlightTag").addEventListener("click",(()=>{const e=document.createElement("div");e.classList.add("mb-2"),e.innerHTML='\n      <input type="text" class="form-control" placeholder="Add a tag" />\n      <button type="button" class="btn btn-danger btn-sm mt-2 remove-tag">- Remove</button>\n    ',e.querySelector(".remove-tag").addEventListener("click",(()=>{n.removeChild(e)})),n.appendChild(e)}));document.getElementById("addHighlightPoint").addEventListener("click",(()=>{const e=document.createElement("div");e.classList.add("mb-2"),e.innerHTML='\n      <input type="text" class="form-control" placeholder="Add a highlight point" />\n      <button type="button" class="btn btn-danger btn-sm mt-2 remove-tag">- Remove</button>\n    ',e.querySelector(".remove-tag").addEventListener("click",(()=>{o.removeChild(e)})),o.appendChild(e)})),fetchData("listing","listings-container",currentPage)}));